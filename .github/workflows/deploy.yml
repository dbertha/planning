name: Deploy to OVH VPS

on:
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      # Nom du fichier .env temporaire crÃ©Ã© pendant le job
      ENV_TMP: .env.tmp

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Debug environment
        run: |
          echo "ğŸ” Informations sur l'environnement GitHub Actions:"
          echo "ğŸ“… Date/Heure: $(date -Iseconds)"
          echo "ğŸ·ï¸  Ref: ${{ github.ref }}"
          echo "ğŸ“ SHA: ${{ github.sha }}"
          echo "ğŸ‘¤ Actor: ${{ github.actor }}"
          echo "ğŸ”„ Event: ${{ github.event_name }}"
          echo "ğŸ“‚ Workspace: ${{ github.workspace }}"
          echo "ğŸ§ Runner OS: ${{ runner.os }}"
          echo ""
          echo "ğŸ“‹ Fichiers dans le workspace:"
          ls -la || true
          echo ""
          echo "ğŸ” VÃ©rification des fichiers critiques:"
          [ -f ".env.example" ] && echo "âœ… .env.example trouvÃ©" || echo "âŒ .env.example manquant"
          [ -f "scripts/deploy.sh" ] && echo "âœ… scripts/deploy.sh trouvÃ©" || echo "âŒ scripts/deploy.sh manquant"

      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_PRIVATE_KEY }}
          log-public-key: false

      - name: Validate DEPLOY_SECRETS exists
        run: |
          echo "ğŸ” Validation des secrets GitHub Actions..."
          if [ -z "${{ secrets.DEPLOY_SECRETS }}" ]; then
            echo "âŒ Error: DEPLOY_SECRETS secret is not set in repository secrets."
            echo "ğŸ“ Please add the DEPLOY_SECRETS secret in GitHub repository settings."
            exit 1
          fi
          echo "âœ… DEPLOY_SECRETS secret found"
          echo "ğŸ“ Secret length: $(echo '${{ secrets.DEPLOY_SECRETS }}' | wc -c) characters"

      - name: Decode deploy secrets into .env.tmp
        run: |
          echo "ğŸ”„ DÃ©codage du secret DEPLOY_SECRETS..."
          echo "ğŸ“‚ CrÃ©ation du fichier temporaire: $ENV_TMP"
          
          # Tentative de dÃ©codage avec gestion d'erreur amÃ©liorÃ©e
          if echo "${{ secrets.DEPLOY_SECRETS }}" | base64 --decode > $ENV_TMP 2>&1; then
            echo "âœ… DÃ©codage base64 rÃ©ussi"
            echo "ğŸ“„ Fichier crÃ©Ã©: $ENV_TMP"
            echo "ğŸ“ Taille du fichier dÃ©codÃ©: $(wc -c < $ENV_TMP) bytes"
            echo "ğŸ“ Nombre de lignes: $(wc -l < $ENV_TMP)"
          else
            echo "âŒ Erreur lors du dÃ©codage base64"
            echo "ğŸ” VÃ©rification du format du secret..."
            echo "ğŸ“ Longueur du secret brut: $(echo '${{ secrets.DEPLOY_SECRETS }}' | wc -c)"
            echo "ğŸ”¤ Premiers caractÃ¨res: $(echo '${{ secrets.DEPLOY_SECRETS }}' | head -c 50)..."
            exit 1
          fi
          
          echo "---- Contenu dÃ©codÃ© (10 premiÃ¨res lignes) ----"
          head -n 10 $ENV_TMP || true
          echo "---- Fin de l'aperÃ§u ----"

      - name: Check .env.example keys exist in decoded secrets
        id: checkkeys
        run: |
          set -e
          echo "ğŸ” VÃ©rification des clÃ©s requises..."
          
          # read keys from .env.example (ignore comments & empty lines)
          KEYS=$(grep -v '^\s*#' .env.example | grep -v '^\s*$' | cut -d'=' -f1 | tr -d '\r')
          TOTAL_KEYS=$(echo "$KEYS" | wc -w)
          echo "ğŸ“‹ ClÃ©s requises trouvÃ©es dans .env.example: $TOTAL_KEYS"
          echo "ğŸ“ Liste des clÃ©s: $(echo $KEYS | tr ' ' ',')"
          
          MISSING=0
          MISSING_KEYS=""
          FOUND_KEYS=""
          
          for key in $KEYS; do
            # check whether key is present in decoded .env
            if grep -q -E "^${key}=" $ENV_TMP; then
              FOUND_KEYS="$FOUND_KEYS $key"
              echo "âœ… $key: prÃ©sent"
            else
              echo "âŒ $key: MANQUANT"
              MISSING_KEYS="$MISSING_KEYS $key"
              MISSING=1
            fi
          done
          
          echo ""
          echo "ğŸ“Š RÃ©sumÃ© de la vÃ©rification:"
          echo "âœ… ClÃ©s trouvÃ©es: $(echo $FOUND_KEYS | wc -w)/$TOTAL_KEYS"
          if [ "$MISSING" -eq 1 ]; then
            echo "âŒ ClÃ©s manquantes: $(echo $MISSING_KEYS | wc -w)"
            echo "ğŸ” ClÃ©s manquantes: $(echo $MISSING_KEYS | tr ' ' ',')"
            echo "::error ::One or more required secrets are missing in DEPLOY_SECRETS. Aborting deployment."
            exit 1
          fi
          echo "ğŸ‰ Toutes les clÃ©s requises sont prÃ©sentes!"

      - name: Copy .env to server and deploy
        env:
          SERVER_USER: ${{ secrets.DEPLOY_SSH_USER }}
          SERVER_HOST: ${{ secrets.DEPLOY_SSH_HOST }}
          REMOTE_APP_DIR: /srv/ecole-app
        run: |
          echo "ğŸš€ DÃ©but du dÃ©ploiement sur le serveur..."
          
          # sanity checks
          echo "ğŸ” VÃ©rification des paramÃ¨tres de connexion SSH..."
          if [ -z "$SERVER_USER" ] || [ -z "$SERVER_HOST" ]; then
            echo "âŒ SERVER_USER or SERVER_HOST secrets not set."
            echo "ğŸ“ Please set DEPLOY_SSH_USER and DEPLOY_SSH_HOST in repository secrets."
            exit 2
          fi
          
          echo "âœ… ParamÃ¨tres SSH validÃ©s:"
          echo "ğŸ‘¤ USER: $SERVER_USER"
          echo "ğŸ–¥ï¸  HOST: $SERVER_HOST"
          echo "ğŸ“ REMOTE_DIR: $REMOTE_APP_DIR"
          
          # copy .env
          echo "ğŸ“¤ Copie du fichier .env vers le serveur..."
          if scp -o StrictHostKeyChecking=no -v $ENV_TMP ${SERVER_USER}@${SERVER_HOST}:${REMOTE_APP_DIR}/.env; then
            echo "âœ… Fichier .env copiÃ© avec succÃ¨s"
          else
            echo "âŒ Ã‰chec de la copie du fichier .env"
            exit 2
          fi

          # run deployment script on server (executes as $SERVER_USER)
          echo "ğŸ”§ ExÃ©cution du script de dÃ©ploiement sur le serveur..."
          ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_HOST} bash -lc "
            set -euo pipefail
            echo 'ğŸ“ Connexion SSH Ã©tablie sur le serveur'
            echo 'ğŸ“ Navigation vers le rÃ©pertoire: ${REMOTE_APP_DIR}'
            cd ${REMOTE_APP_DIR}
            
            echo 'ğŸ“¥ Mise Ã  jour du code depuis Git...'
            git fetch --all --prune
            git reset --hard origin/main
            echo 'âœ… Code mis Ã  jour'
            
            echo 'ğŸ” VÃ©rification du script de dÃ©ploiement...'
            if [ -f scripts/deploy.sh ]; then
              echo 'âœ… Script scripts/deploy.sh trouvÃ©'
              chmod +x scripts/deploy.sh
              echo 'ğŸš€ Lancement du dÃ©ploiement...'
              ./scripts/deploy.sh
              echo 'ğŸ‰ DÃ©ploiement terminÃ© avec succÃ¨s!'
            else
              echo 'âŒ scripts/deploy.sh not found in repo. Please add it.'
              exit 3
            fi
          "
          
          echo "ğŸ‰ DÃ©ploiement terminÃ© avec succÃ¨s!"
